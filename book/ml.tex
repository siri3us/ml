\documentclass{book}
\usepackage[english, russian]{babel}
\usepackage[utf8]{inputenc}
\usepackage[margin=0.75in]{geometry}
\usepackage{paralist}
\usepackage{amsthm, amsmath, amsfonts, amssymb}
%\usepackage{bbold}
\usepackage{dsfont}
\usepackage{mathtools}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{algorithm}
\usepackage{algpseudocode} 
\usepackage{multirow}
\usepackage{comment}

% Next goes different graphic related issues are discussed
\usepackage{xcolor, colortbl}
\usepackage{tikz}
\usepackage{xifthen}
\usetikzlibrary{arrows}
\usetikzlibrary{positioning}
\usepackage{pgf}
\usepackage{pgfplots}

\definecolor{grey1}{RGB}{192,192,192}
\definecolor{lemonchiffon}{RGB}{255,250,205}
\definecolor{yellowgreen}{RGB}{154,205,50}
\definecolor{chocolate}{RGB}{210,105,30}
\definecolor{purple}{RGB}{128,0,128}

\usepackage{sectsty}
%\subsectionfont{\color{blue}}
\subsubsectionfont{\color{red}}  % sets colour of sections

\usepackage{caption,subcaption}

\usepackage{bm}

\usepackage{indentfirst} % Отступ в начале chapter, section, subsection и т.д.

\newtheorem{theorem}{Теорема}
\numberwithin{theorem}{chapter}

\newtheorem{statement}{Утверждение}
\numberwithin{statement}{chapter}

\newtheorem{lemma}{Лемма}
\numberwithin{lemma}{chapter}

\newtheorem{consequence}{Следствие}

\theoremstyle{definition}
\newtheorem{task}{Задание}
\numberwithin{task}{chapter}

\theoremstyle{remark}
\newtheorem{example}{Пример}
\numberwithin{example}{chapter}

\newtheorem{assumption}{Предположение}

\theoremstyle{definition}
\newtheorem{definition}{Определение}
\numberwithin{definition}{chapter}

\theoremstyle{remark}
\newtheorem{note}{Замечание}
\theoremstyle{remark}
\newtheorem{lyrics}{Лирическое отступление}
\numberwithin{lyrics}{section}

%\renewenvironment{itemize}[1]{\begin{compactitem}#1}{\end{compactitem}}
%\renewenvironment{enumerate}[1]{\begin{compactenum}#1}{\end{compactenum}}
%\renewenvironment{description}[0]{\begin{compactdesc}}{\end{compactdesc}}

\newcommand{\param}[1]{\textbf{#1}}
\newcommand{\numberof}[1]{\#[\text{#1}]}
\newcommand{\underquestion}[1]{\textbf{#1 (Check!)}}
\newcommand{\TODO}[1]{\textbf{[TODO:#1]}}

% Комманды для комментариев
\newcommand{\ignore}[1]{}
\newcommand{\hidden}[1]{}
\newcommand{\translation}[1]{}

\DeclareMathAlphabet{\mathbbold}{U}{bbold}{m}{n}


\begin{document}
\title{Глубинное Обучение}
\author{Иванов Александр \\ ИППИ РАН}
\date{}
\maketitle
	
\tableofcontents
	
\include{commands}

\chapter{Полносвязные Сети}

\chapter{Сверточные Сети}

\section{Обратное распространение ошибки}

\subsection{Случай $\text{stride} = 1$}

\begin{equation}
\partder{\Loss}{\Input[c, h, w]}= \Sum_{(i, j) \in \FilterCoverageSet(h, w)} 
\partder{\Output[c, i, j]}{\Input[c, h, w]} \cdot \partder{\Loss}{\Output[c, i, j]}
\end{equation}

\begin{align}
\FilterCoverageSet(h)& = \{i \colon \max\{0, h - \FilterSize[h]\} \le i \le \min\{h, H - \FilterSize[h]\}\}, \\
\FilterCoverageSet(w)& = \{j \colon \min\{0, w - \FilterSize[w]\} \le j \le \max\{w, W - \FilterSize[w]\}\}.
\end{align}

\begin{equation}
\FilterCoverageSet(h, w) \triangleq \{(i, j)\colon i \in \FilterCoverageSet(h), j\in \FilterCoverageSet(w)\}.
\end{equation}


\begin{equation}
\label{eq:conv:backprop:1}
\partder{\Loss}{\Input[c, h, w]}= \Sum_{(i, j) \in \FilterCoverageSet(h, w)} 
\partder{\Output[c, i, j]}{\Input[c, h, w]} \cdot \partder{\Loss}{\Output[c, i, j]} = 
\Sum_{(i, j) \in \FilterCoverageSet(h, w)} W[c, h - i, w - j] \partder{\Loss}{\Output[c, i, j]}
\end{equation}
Уже здесь можно заметить, что нахождение производных по $\Input$ напоминает свертку производных по выходу $\partder{\Loss}{\Output}$
с транспонированной (вдоль второго и третьего измерений) матрицей весов $W$.

Рассмотрим пока для определенности только точки $(h, w)$ из диапазона $(h, w) \in [\FilterSize[h] - 1, H - \FilterSize[h]] \times [\FilterSize[w] - 1, W - \FilterSize[w]]$. В этом случае сумму из~\eqref{eq:conv:backprop:1} можно записать в виде
\begin{equation}
\label{eq:conv:backprop:2}
\partder{\Loss}{\Input[c, h, w]} = \Sum_{\substack{i \in [h - \FilterSize[h] + 1, h] \\ j \in [w - \FilterSize[w] + 1, w]}} W[c, h - i, w - j] \partder{\Loss}{\Output[c, i, j]},
\end{equation}
не содержащим граничных условий на $i$ и $j$. Далее введем транспонированную вдоль второго и третьего измерений матрицу весов $W'$:
\begin{equation}
W'[i, j] = W[c, \FilterSize[h] - 1 - i, \FilterSize[w] - 1 - j], \quad c \in [0, \NumOfFilters - 1], i \in [0, \FilterSize[h] - 1], j \in [0, \FilterSize[w] - 1].
\end{equation}
В таком случае~\eqref{eq:conv:backprop:2} можно далее записать в виде
\begin{equation}
\partder{\Loss}{\Input[c, h, w]} = \Sum_{\substack{i \in [h - \FilterSize[h] + 1, h] \\ j \in [w - \FilterSize[w] + 1, w]}} W'[c, i, j] \partder{\Loss}{\Output[c, i, j]}.
\end{equation}

Можно в принципе избавиться от граничных условий и записать для любых $(h, w) \in [0, H - 1] \times 0, W - 1]$, если положить, что значения по индексам, отсутствующим в матрице $\partial \Loss / \partial I$, равны нулю:
\begin{equation}
\partder{\Loss}{\Input[c, h, w]} = \Sum_{\substack{i \in [h - \FilterSize[h] + 1, h] \\ j \in [w - \FilterSize[w] + 1, w]}} W'[c, i, j] \partder{\Loss}{\Output[c, i, j]}.
\end{equation}
Фактически это эквивалентно тому, что матрица $\partder{\Loss}{\Output[c, i, j]}$ дополняется $\FilterSize[h] - 1$ вдоль второго измерения и $\FilterSize[w] - 1$ вдоль третьего измерения с каждой стороны. Полученная матрица имеет размер $(H + \FilterSize[h] - 1) \times (W + \FilterSize[w] - 1)$. 

\subsection{Случай $\text{stride} = 2$}

\begin{equation}
\partder{\Loss}{\Input[c, h, w]}= \Sum_{(i, j) \in \FilterCoverageSet(h, w)} 
\partder{\Output[c, i, j]}{\Input[c, h, w]} \cdot \partder{\Loss}{\Output[c, i, j]}
\end{equation}


\bibliographystyle{ugost2008}
\bibliography{../bib/phy.bib}

\end{document}