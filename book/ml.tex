\documentclass{book}
\usepackage[english, russian]{babel}
\usepackage[utf8]{inputenc}
\usepackage[margin=0.75in]{geometry}
\usepackage{paralist}
\usepackage{amsthm, amsmath, amsfonts, amssymb}
%\usepackage{bbold}
\usepackage{dsfont}
\usepackage{mathtools}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{algorithm}
\usepackage{algpseudocode} 
\usepackage{multirow}
\usepackage{comment}

% Next goes different graphic related issues are discussed
\usepackage{xcolor, colortbl}
\usepackage{tikz}
\usepackage{xifthen}
\usetikzlibrary{arrows}
\usetikzlibrary{positioning}
\usepackage{pgf}
\usepackage{pgfplots}

\definecolor{grey1}{RGB}{192,192,192}
\definecolor{lemonchiffon}{RGB}{255,250,205}
\definecolor{yellowgreen}{RGB}{154,205,50}
\definecolor{chocolate}{RGB}{210,105,30}
\definecolor{purple}{RGB}{128,0,128}

\usepackage{sectsty}
%\subsectionfont{\color{blue}}
\subsubsectionfont{\color{red}}  % sets colour of sections

\usepackage{caption,subcaption}

\usepackage{bm}

\usepackage{indentfirst} % Отступ в начале chapter, section, subsection и т.д.

\newtheorem{theorem}{Теорема}
\numberwithin{theorem}{chapter}

\newtheorem{statement}{Утверждение}
\numberwithin{statement}{chapter}

\newtheorem{lemma}{Лемма}
\numberwithin{lemma}{chapter}

\newtheorem{consequence}{Следствие}

\theoremstyle{definition}
\newtheorem{task}{Задание}
\numberwithin{task}{chapter}

\theoremstyle{remark}
\newtheorem{example}{Пример}
\numberwithin{example}{chapter}

\newtheorem{assumption}{Предположение}

\theoremstyle{definition}
\newtheorem{definition}{Определение}
\numberwithin{definition}{chapter}

\theoremstyle{remark}
\newtheorem{note}{Замечание}
\theoremstyle{remark}
\newtheorem{lyrics}{Лирическое отступление}
\numberwithin{lyrics}{section}

%\renewenvironment{itemize}[1]{\begin{compactitem}#1}{\end{compactitem}}
%\renewenvironment{enumerate}[1]{\begin{compactenum}#1}{\end{compactenum}}
%\renewenvironment{description}[0]{\begin{compactdesc}}{\end{compactdesc}}

\newcommand{\param}[1]{\textbf{#1}}
\newcommand{\numberof}[1]{\#[\text{#1}]}
\newcommand{\underquestion}[1]{\textbf{#1 (Check!)}}
\newcommand{\TODO}[1]{\textbf{[TODO:#1]}}

% Комманды для комментариев
\newcommand{\ignore}[1]{}
\newcommand{\hidden}[1]{}
\newcommand{\translation}[1]{}

\DeclareMathAlphabet{\mathbbold}{U}{bbold}{m}{n}


\begin{document}
\title{Глубинное Обучение}
\author{Иванов Александр \\ ИППИ РАН}
\date{}
\maketitle
	
\tableofcontents
	
\include{commands}

\chapter{Полносвязные Сети}

\chapter{Сверточные Сети}

\section{Обратное распространение ошибки}

\subsection{Случай $\text{stride} = 1$}

\begin{equation}
\partder{\Loss}{\Input[c, h, w]}= \Sum_{(i, j) \in \AffectField(h, w)} 
\partder{\Output[c, i, j]}{\Input[c, h, w]} \cdot \partder{\Loss}{\Output[c, i, j]}
\end{equation}

Введем вспомогательные термины. 

\paragraph{Область действия.}
Рассмотрим элемент $\Input[h, w]$ входа сверточного слоя ($h \in [0, H - 1]$, $w \in [0, W - 1]$). \textbf{Областью действия} $\AffectField(h, w)$ элемента $\Input[h, w]$ называется множество координат элементов матрицы $\Output$, которые зависят от элемента $I[h, w]$:
\begin{equation}
\AffectField(h, w) \triangleq \{(i, j)\colon i \in \AffectField(h), j\in \AffectField(w)\},
\end{equation}
где
\begin{align}
\AffectField(h)& = \{i \colon \max\{0, h - \FilterSize[h]\} \le i \le \min\{h, H - \FilterSize[h]\}\}, \\
\AffectField(w)& = \{j \colon \min\{0, w - \FilterSize[w]\} \le j \le \max\{w, W - \FilterSize[w]\}\}.
\end{align}

\paragraph{Область восприимчивости.}
Теперь рассмотрим элемент $\Output[i, j]$ выхода сверточного слоя ($i \in [0, H - \FilterSize_h]$, $j \in [0, W - \FilterSize_w]$). \textbf{Областью восприимчивости} $\ReceptiveField(h, w)$ элемента $\Output[i, j]$ называется множество координат элементов матрицы $\Input$, от которых зависит значение элемента $\Output[i, j]$:
\begin{equation}
\label{eq:receptive_field}
\ReceptiveField(i, j) = \{(h, w) \colon h \in \ReceptiveField(i), w \in \ReceptiveField(j)\},
\end{equation}
где
\begin{align}
\label{eq:receptive_field:add}
\ReceptiveField(i) &= \{h \colon i \le h \le \min\{i + \FilterSize_h - 1, H - 1\}\}, \\
\ReceptiveField(j) &= \{w \colon j \le w \le \min\{j + \FilterSize_w - 1, W - 1\}\}.
\end{align}


\begin{equation}
\label{eq:conv:backprop:1}
\partder{\Loss}{\Input[c, h, w]}= \Sum_{(i, j) \in \AffectField(h, w)} 
\partder{\Output[c, i, j]}{\Input[c, h, w]} \cdot \partder{\Loss}{\Output[c, i, j]} = 
\Sum_{(i, j) \in \AffectField(h, w)} W[c, h - i, w - j] \partder{\Loss}{\Output[c, i, j]}
\end{equation}
Уже здесь можно заметить, что нахождение производных по $\Input$ напоминает свертку производных по выходу $\partder{\Loss}{\Output}$
с транспонированной (вдоль второго и третьего измерений) матрицей весов $W$.

Рассмотрим пока для определенности только точки $(h, w)$ из диапазона $(h, w) \in [\FilterSize[h] - 1, H - \FilterSize[h]] \times [\FilterSize[w] - 1, W - \FilterSize[w]]$. В этом случае сумму из~\eqref{eq:conv:backprop:1} можно записать в виде
\begin{equation}
\label{eq:conv:backprop:2}
\partder{\Loss}{\Input[c, h, w]} = \Sum_{\substack{i \in [h - \FilterSize[h] + 1, h] \\ j \in [w - \FilterSize[w] + 1, w]}} W[c, h - i, w - j] \partder{\Loss}{\Output[c, i, j]},
\end{equation}
не содержащим граничных условий на $i$ и $j$. Далее введем транспонированную вдоль второго и третьего измерений матрицу весов $W'$:
\begin{equation}
W'[i, j] = W[c, \FilterSize[h] - 1 - i, \FilterSize[w] - 1 - j], \quad c \in [0, \NumOfFilters - 1], i \in [0, \FilterSize[h] - 1], j \in [0, \FilterSize[w] - 1].
\end{equation}
В таком случае~\eqref{eq:conv:backprop:2} можно далее записать в виде
\begin{equation}
\partder{\Loss}{\Input[c, h, w]} = \Sum_{\substack{i \in [h - \FilterSize[h] + 1, h] \\ j \in [w - \FilterSize[w] + 1, w]}} W'[c, i, j] \partder{\Loss}{\Output[c, i, j]}.
\end{equation}

Можно в принципе избавиться от граничных условий и записать для любых $(h, w) \in [0, H - 1] \times 0, W - 1]$, если положить, что значения по индексам, отсутствующим в матрице $\partial \Loss / \partial I$, равны нулю:
\begin{equation}
\partder{\Loss}{\Input[c, h, w]} = \Sum_{\substack{i \in [h - \FilterSize[h] + 1, h] \\ j \in [w - \FilterSize[w] + 1, w]}} W'[c, i, j] \partder{\Loss}{\Output[c, i, j]}.
\end{equation}
Фактически это эквивалентно тому, что матрица $\partder{\Loss}{\Output[c, i, j]}$ дополняется $\FilterSize[h] - 1$ вдоль второго измерения и $\FilterSize[w] - 1$ вдоль третьего измерения с каждой стороны. Полученная матрица имеет размер $(H + \FilterSize[h] - 1) \times (W + \FilterSize[w] - 1)$. 

\subsection{Общий случай $\text{stride} \ge 1$}
В данном случае размер матрицы $\Input$ как и ранее есть $H \times W$. В общем случае $\StrideSize_h \ge 1$ и/или $\StrideSize_w \ge 1$ для размеры $H' $ и $W'$ матрицы $\Output$ равны
\begin{equation}
H' = \frac{H - \FilterSize_h}{\StrideSize_h} + 1, \qquad W' = \frac{W - \FilterSize_w}{\StrideSize_w} + 1.
\end{equation}
Здесь как и ранее полагаем, что значения $H$, $W$, $\StrideSize$, $\FilterSize$ согласованы путем, например, предварительного дополнения входа сверточного слоя нулями, так что $H'$  и $W'$ --- целые числа.

В данном случае требуется скорректировать ранее введенные области действия и восприимчивости.

\paragraph{Область восприимчивости $\ReceptiveField(i, j)$}
Рассмотрим элемент $\Output[i, j]$ ($i \in [0, H'- 1]$, $j \in [0, W' - 1]$). Этот элемент зависит элементов матрицы $\Input$, расположенных по следующим координатам $\{(h, w)\}$:
\begin{gather*}
h \in [i \cdot \StrideSize_h, i \cdot \StrideSize_h + \FilterSize_h - 1], \\
w \in [j \cdot \StrideSize_w, j \cdot \StrideSize_w + \FilterSize_w - 1].
\end{gather*}
Заметим, что при всех допустимых $i \in [0, H'- 1]$ и $j \in [0, W' - 1]$ значения $h$ и $w$ лежат в допустимых множествах $[0, H - 1]$ и $[0, W - 1]$. Таким образом, область восприимчивости имеет вид:
\begin{equation}
\ReceptiveField(i, j) = \{(h, w)\colon h \in [i \cdot \StrideSize_h, i \cdot \StrideSize_h + \FilterSize_h - 1], w \in [j \cdot \StrideSize_w, j \cdot \StrideSize_w + \FilterSize_w - 1]\}, \quad i \in [0, H'- 1], j \in [0, W' - 1].
\end{equation}

\paragraph{Область влияния (действия).}
Рассмотрим, на какие элементы матрицы $\Output$ влияет элемент $\Input[h, w]$. Чтобы элемент $\Input[h, w]$ влиял на $\Output[i, j]$, нужно, чтобы $(h, w) \in \ReceptiveField(i, j)$, т.е.
\begin{equation}
i \cdot \StrideSize_h \le h \le i \cdot \StrideSize_h + \FilterSize_h - 1, \qquad j \cdot \StrideSize_w \le w \le j \cdot \StrideSize_w + \FilterSize_w - 1.
\end{equation}
Осталось лишь определить все те пары $(i, j)$, для которых данное условие выполнено. 



\begin{equation}
\partder{\Loss}{\Input[h, w]}= \Sum_{(i, j) \in \AffectField(h, w; s)} 
\partder{\Output[i, j]}{\Input[h, w]} \cdot \partder{\Loss}{\Output[i, j]}
\end{equation}


\bibliographystyle{ugost2008}
\bibliography{../bib/phy.bib}

\end{document}